<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Donna.ai</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-brand">
                <h1>ðŸ¤– Donna.ai</h1>
            </div>
            <div class="nav-links">
                <span id="user-name" class="user-name"></span>
                <a href="/auth/logout" class="btn-secondary">Logout</a>
            </div>
        </div>
    </nav>

    <div class="container dashboard">
        <div class="dashboard-header">
            <h2>Welcome to Your Dashboard</h2>
            <p>Manage your AI assistant and account settings</p>
        </div>

        <!-- Alert Section -->
        <div id="alert-section"></div>

        <!-- Activate Agent Section -->
        <div class="card highlight-card">
            <div class="card-header">
                <h3>ðŸš€ Activate Donna</h3>
            </div>
            <div class="card-body">
                <p>Click the button below to activate Donna. She will immediately call you with a summary of your emails and calendar events.</p>
                <button id="activate-btn" class="btn-primary btn-large" onclick="activateAgent()">
                    ðŸ“ž Call Me Now
                </button>
                <p class="help-text">Make sure your phone number is set below before activating.</p>
            </div>
        </div>

        <div class="dashboard-grid">
            <!-- Profile Section -->
            <div class="card">
                <div class="card-header">
                    <h3>ðŸ‘¤ Profile</h3>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label>Name</label>
                        <input type="text" id="name" class="form-input" placeholder="Your name">
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="email" class="form-input" disabled>
                    </div>
                    <div class="form-group">
                        <label>Phone Number</label>
                        <input type="tel" id="phone" class="form-input" placeholder="+1234567890">
                        <small>Format: +1234567890 (include country code)</small>
                    </div>
                    <button class="btn-primary" onclick="updateProfile()">Save Changes</button>
                </div>
            </div>

            <!-- Google Connection Status -->
            <div class="card">
                <div class="card-header">
                    <h3>ðŸ”— Connections</h3>
                </div>
                <div class="card-body">
                    <div class="connection-item">
                        <div class="connection-info">
                            <span class="icon">ðŸ“§</span>
                            <span>Gmail</span>
                        </div>
                        <span class="badge" id="gmail-badge">Checking...</span>
                    </div>
                    <div class="connection-item">
                        <div class="connection-info">
                            <span class="icon">ðŸ“…</span>
                            <span>Google Calendar</span>
                        </div>
                        <span class="badge" id="calendar-badge">Checking...</span>
                    </div>
                    <p class="help-text">These services are connected through your Google account. Donna uses them to fetch your emails and calendar events.</p>
                </div>
            </div>

            <!-- Quick Stats -->
            <div class="card">
                <div class="card-header">
                    <h3>ðŸ“Š Quick Info</h3>
                </div>
                <div class="card-body">
                    <div class="stat-item">
                        <span class="stat-label">Unique Code:</span>
                        <span class="stat-value" id="unique-code">-</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Account Created:</span>
                        <span class="stat-value" id="created-at">-</span>
                    </div>
                    <p class="help-text">Your unique code is used internally to identify your agent sessions.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let userData = null;

        // Load user data on page load
        async function loadUserData() {
            try {
                const response = await fetch('/auth/me');
                if (!response.ok) {
                    window.location.href = '/';
                    return;
                }
                
                userData = await response.json();
                
                // Populate form
                document.getElementById('name').value = userData.name || '';
                document.getElementById('email').value = userData.email || '';
                document.getElementById('phone').value = userData.phone || '';
                document.getElementById('user-name').textContent = userData.name || userData.email;
                document.getElementById('unique-code').textContent = userData.unique_code || '-';
                
                // Format created date
                if (userData.created_at) {
                    const date = new Date(userData.created_at);
                    document.getElementById('created-at').textContent = date.toLocaleDateString();
                }
                
                // Update connection status
                updateConnectionStatus();
                
            } catch (error) {
                console.error('Error loading user data:', error);
                showAlert('Error loading user data', 'error');
            }
        }

        function updateConnectionStatus() {
            // Gmail status
            const gmailBadge = document.getElementById('gmail-badge');
            if (userData.gmail_connected) {
                gmailBadge.textContent = 'Connected';
                gmailBadge.className = 'badge badge-success';
            } else {
                gmailBadge.textContent = 'Connected via OAuth';
                gmailBadge.className = 'badge badge-success';
            }
            
            // Calendar status
            const calendarBadge = document.getElementById('calendar-badge');
            if (userData.calendar_connected) {
                calendarBadge.textContent = 'Connected';
                calendarBadge.className = 'badge badge-success';
            } else {
                calendarBadge.textContent = 'Connected via OAuth';
                calendarBadge.className = 'badge badge-success';
            }
        }

        async function updateProfile() {
            const name = document.getElementById('name').value;
            const phone = document.getElementById('phone').value;
            
            if (!phone) {
                showAlert('Please enter your phone number', 'warning');
                return;
            }
            
            // Basic phone validation
            const phoneRegex = /^\+?[1-9]\d{10,14}$/;
            if (!phoneRegex.test(phone.replace(/[\s-]/g, ''))) {
                showAlert('Please enter a valid phone number with country code (e.g., +1234567890)', 'error');
                return;
            }
            
            try {
                const response = await fetch('/auth/update-profile', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ name, phone })
                });
                
                if (response.ok) {
                    showAlert('Profile updated successfully!', 'success');
                    await loadUserData();
                } else {
                    const error = await response.json();
                    showAlert(error.detail || 'Failed to update profile', 'error');
                }
            } catch (error) {
                console.error('Error updating profile:', error);
                showAlert('Error updating profile', 'error');
            }
        }

        async function activateAgent() {
            if (!userData.phone) {
                showAlert('Please add your phone number first!', 'warning');
                document.getElementById('phone').focus();
                return;
            }
            
            const btn = document.getElementById('activate-btn');
            
            // Disable button
            btn.disabled = true;
            btn.textContent = 'ðŸ“ž Activating...';
            
            try {
                const response = await fetch('/activate-agent', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showAlert('ðŸŽ‰ Agent activated! You should receive a call shortly.', 'success');
                } else {
                    showAlert(result.detail || 'Failed to activate agent', 'error');
                }
            } catch (error) {
                console.error('Error activating agent:', error);
                showAlert('Error activating agent: ' + error.message, 'error');
            } finally {
                // Re-enable button after 5 seconds
                setTimeout(() => {
                    btn.disabled = false;
                    btn.textContent = 'ðŸ“ž Call Me Now';
                }, 5000);
            }
        }

        function showAlert(message, type = 'info') {
            const alertSection = document.getElementById('alert-section');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            
            alertSection.innerHTML = '';
            alertSection.appendChild(alert);
            
            // Auto-dismiss after 5 seconds
            setTimeout(() => {
                alert.style.opacity = '0';
                setTimeout(() => alert.remove(), 300);
            }, 5000);
        }

        // Load data on page load
        loadUserData();
    </script>
</body>
</html>
